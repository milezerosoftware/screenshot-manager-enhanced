# Issue Resolution Plan: feat: Embed Metadata in Screenshots

**Issue Link**: [New Feature]
**Proposed Branch**: `feat/metadata`

## Issue Summary

The goal is to embed rich metadata into the screenshot files (PNG) generated by the game. This allows external tools (Lightroom, Photoshop, OS file explorers) to index and display information about the screenshot, such as the world name, coordinates, and date.

**User Request**: "Research the standards popular image manipulation applications use for adding the specific proprietary metadata elements."

## Research Findings: Metadata Standards

1. **XMP (Extensible Metadata Platform)**:
    - **Standard**: Created by Adobe, widely adopted by Photoshop, Lightroom, and other professional tools.
    - **PNG Implementation**: XMP data is embedded in a standardized `iTXt` chunk with the keyword `XML:com.adobe.xmp`.
    - **Pros**: Highly compatible with "proprietary" tools (Adobe suite), extensible, supports UTF-8.
    - **Cons**: Slightly more complex XML payload.

2. **EXIF**:
    - **Standard**: Older, originally for hardware cameras.
    - **PNG Implementation**: Added to PNG spec in 2017 (`eXIf` chunk).
    - **Pros**: Good for simple timestamps and GPS.
    - **Cons**: Less support in older PNG readers; strictly defined schema (harder to add "World Name").

3. **PNG Text Chunks (`tEXt`/`zTXt`)**:
    - **Standard**: Native PNG key-value pairs.
    - **Pros**: Simplest to implement.
    - **Cons**: Not standardly displayed in photo management software like Lightroom.

**Decision**: We will implement **XMP embedded in `iTXt` chunks**. This provides the best compatibility with the professional tools mentioned by the user (Lightroom/Photoshop) and allows for custom fields (like "Minecraft World").

## Implementation Plan

### 1. New Dependency vs. Custom Implementation

To avoid bloating the mod with large libraries (like Apache Commons Imaging), we will implement a lightweight **PNG Chunk Injector**.

- **Role**: Read the generated PNG, find the correct insertion point (after IHDR), insert the `iTXt` chunk with XMP data, and write the rest of the file.
- **Complexity**: Low/Medium (PNG structure is simple).

### 2. Metadata Fields Mapping

We will map Minecraft data to standard XMP schemas where possible:

| Minecraft Data | XMP Field | Schema |
| :--- | :--- | :--- |
| Timestamp | `xmp:CreateDate` | XMP Basic |
| Mod Name/Ver | `xmp:CreatorTool` | XMP Basic |
| World Name | `dc:description` / `dc:title` | Dublin Core |
| Dimensions | `exif:PixelXDimension` | EXIF |
| Coordinates | `exif:GPSLatitude`, `exif:GPSLongitude`, `exif:GPSAltitude` | EXIF (2D + Height) |
| **Custom Data** | **Namespace: `mc`** | **Custom Schema** |
| Coordinates | `mc:Coordinates` (Format: "x, y, z") | Custom |
| Biome | `mc:Biome` | Custom |
| Server IP | `mc:Server` | Custom |

### 3. Integration Point

**Status: To Be Determined**

The previously proposed "Post-Processing Hook" (ThreadLocal + Notification Mixin) was unreliable and has been discarded. We need a new, robust strategy to detect when the screenshot file has been successfully written to disk before we can inject metadata.

**Potential Candidates for Investigation:**

- Mixin into `NativeImage.writeTo(...)`.
- Mixin into the internal method calling `writeTo` within `ScreenshotRecorder`.
- File Watcher (less reliable).

### 4. Configuration

- **Toggle**: `enableMetadata` (already in `ModConfig`).
- **Privacy**: Maybe an option to exclude Server IP/Coords? (Future scope).

## Step-by-Step Implementation

1. **Branch setup**: `feat/metadata`
2. **XMP Generator**: Create `XmpBuilder` class to construct the XML packet.
3. **PNG Injector**: Create `PngMetadataWriter` to handle binary file I/O and chunk injection.
4. **Data Collection**: Create `MetadataCollector` to gather game state (player pos, world info) responsibly on the main thread.
5. **Integration**: Hook into `ScreenshotRecorderMixin` to execute the writer after saving.
6. **Verification**: Open screenshots in Photoshop/Lightroom to verify data.

## Verification

- **Manual**: Take screenshot -> Open in Photoshop -> File Info -> Raw Data. Check for our namespaces.
- **Automated**: Integration test that writes a dummy PNG and verifies the `iTXt` chunk exists.
